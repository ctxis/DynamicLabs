---
# Create local user
#
# Parameters:
# name = user name (required)
# description = user description
# password = user password. Autogenerated if not specified.
# enabled = yes (default), no
# shell = user shell (default /bin/bash)
# groups = comma separated list of groups to add the user to
# 
# Example:
#            {
#                name = "Linux_User"
#                value = [
#                    { name = "LocalUser1" }, # Local user with random password
#                    { name = "LocalUser2", enabled = "no"}, # Local user disabled
#                    { # Local user with password, description, custom shell zsh, belonging to group "admin"
#                       name = "LocalUser3", 
#                       password = "Welcome123!!", 
#                       description = "Such and such", 
#                       shell = "/usr/bin/zsh", 
#                       groups = "admin"} 
#                  ]
#            }

# Save the user password 

- set_fact:
    user_password: "{{ item.password }}"
  when: item.password is defined

- local_action:
    module: file
    path: "{{ '~/credentials/local/' + custom_hostname }}"
    state: directory
  when: (item.enabled | default('yes')) == 'yes' and item.password is defined

- local_action:
    module: copy
    dest: "{{ '~/credentials/local/' + custom_hostname + '/' + item.name }}"
    content: "{{ item.password }}"
  when: (item.enabled | default('yes')) == 'yes' and item.password is defined

- set_fact:
    user_password: "{{ lookup('password', '~/credentials/local/' + custom_hostname + '/' + item.name + ' chars=ascii_letters,digits,punctuation length=12') }}"
  when: (item.enabled | default('yes')) == 'yes' and item.password is not defined

- debug:
    var: user_password

- user:
    name: "{{ item.name }}"
    comment: "{{ item.comment | default() }}"
    shell: "{{ item.shell | default('/bin/bash')}}"
    groups: "{{ item.groups | default() }}"
    append: yes
    password: "{{ user_password | password_hash('sha512') }}"
    expires: -1
  when: (item.enabled | default('yes')) == "yes"

- user:
    name: "{{ item.name }}"
    comment: "{{ item.comment | default() }}"
    shell: "{{ item.shell | default('/bin/bash')}}"
    groups: "{{ item.groups | default() }}"
    append: yes
    password: "!"
    expires: -1
  when: (item.enabled | default('yes')) == "no"
